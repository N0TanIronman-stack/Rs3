<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RS3 Stats Anchor Finder (fast)</title>
  <script src="https://runeapps.org/alt1lib.js"></script>
  <style>
    #status { margin-top: 10px; font-weight: bold; color: lime; }
    #debug { margin-top: 10px; font-size: 12px; white-space: pre-line; color: #ccc; }
  </style>
</head>
<body>
  <h2>Anchor Finder Fast Test</h2>
  <button onclick="loadAssets()">Scan Anchors Fast</button>
  <div id="status">Waiting…</div>
  <div id="debug"></div>

  <script>
    let statAnchorData = null;

    function setStatus(msg, color = "lime") {
      const el = document.getElementById("status");
      el.innerText = msg;
      el.style.color = color;
      console.log("STATUS:", msg);
    }
    function setDebug(msg) {
      document.getElementById("debug").innerText = msg;
      console.log("DEBUG:", msg);
    }

    function loadImageData(path, callback) {
      const img = new Image();
      img.crossOrigin = "anonymous";   // might help if image loaded from another origin
      img.src = path;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const imgData = ctx.getImageData(0, 0, img.width, img.height);
        callback(imgData);
      };
      img.onerror = (e) => {
        setStatus(`Failed to load image ${path}`, "red");
        console.error(e);
      };
    }

    function loadAssets() {
      loadImageData("./statanchor.png", data => {
        statAnchorData = data;
        setStatus("Anchor image loaded");
        // Maybe small delay to ensure everything bound
        setTimeout(startFinder, 100);
      });
    }

    function startFinder() {
      if (!window.alt1) {
        setStatus("Not running in Alt1 ❌", "red");
        return;
      }
      if (!alt1.permissionPixel) {
        setStatus("Pixel permission not granted ❌", "red");
        return;
      }
      if (!statAnchorData) {
        setStatus("Anchor image data not loaded ❌", "red");
        return;
      }

      const screenW = alt1.rsWidth || 0;
      const screenH = alt1.rsHeight || 0;
      if (screenW === 0 || screenH === 0) {
        setStatus("Invalid screen dimensions ❌", "red");
        return;
      }

      const screenImg = a1lib.getregion(0, 0, screenW, screenH);
      if (!screenImg) {
        setStatus("Failed to capture screen region ❌", "red");
        return;
      }

      setStatus("Running fast scan…");

      // Use native findSubImage (or findsubimg depending on version)
      let matches = null;
      try {
        // Try both names if unsure
        if (typeof a1lib.findSubImage === "function") {
          matches = a1lib.findSubImage(screenImg, statAnchorData, 35);
        } else if (typeof a1lib.findsubimg === "function") {
          matches = a1lib.findsubimg(screenImg, statAnchorData, 35);
        } else {
          throw new Error("No findSubImage / findsubimg function found");
        }
      } catch (err) {
        setStatus("Error calling findSubImage", "red");
        console.error(err);
        return;
      }

      if (!matches) {
        setStatus("No matches (returned null/undefined)", "red");
      } else if (Array.isArray(matches) && matches.length > 0) {
        setStatus(`Found ${matches.length} anchors ✅`);
        matches.forEach(m => {
          alt1.overLayRect(
            a1lib.mixcolor(0,255,0),
            m.x, m.y,
            statAnchorData.width, statAnchorData.height,
            3000, 3
          );
        });
        setDebug(JSON.stringify(matches, null, 2));
      } else {
        setStatus("Matches array empty ❌", "red");
      }
    }
  </script>
</body>
</html>
