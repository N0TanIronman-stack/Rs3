<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RS3 Ability Bar Finder (multi)</title>
  <script src="https://runeapps.org/alt1lib.js"></script>
  <style>
    #status { margin-top: 10px; font-weight: bold; color: lime; }
    #debug { margin-top: 10px; font-size: 12px; white-space: pre-line; color: #ccc; }
  </style>
</head>
<body>
  <h2>Ability Bar Finder</h2>
  <button onclick="loadAssets()">Scan All Bars</button>
  <div id="status">Waiting…</div>
  <div id="debug"></div>

  <script>
    const icons = {
      AbilityBarHeader: null,
      AbilityBar14x1: null,
      AbilityBar7X2: null,
      AbilityBar1x14: null,
      AbilityBar2x7: null
    };

    function setStatus(msg, color = "lime") {
      const el = document.getElementById("status");
      el.innerText = msg;
      el.style.color = color;
      console.log("STATUS:", msg);
    }
    function setDebug(msg) {
      document.getElementById("debug").innerText = msg;
      console.log("DEBUG:", msg);
    }

    function loadImageData(path, callback) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = path;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        callback(ctx.getImageData(0, 0, img.width, img.height));
      };
      img.onerror = () => setStatus(`Failed to load ${path}`, "red");
    }

    function loadAssets() {
      const keys = Object.keys(icons);
      let loaded = 0;

      keys.forEach(key => {
        loadImageData(`./${key}.png`, data => {
          icons[key] = data;
          loaded++;
          if (loaded === keys.length) {
            setStatus("All icons loaded ✅");
            setTimeout(startFinder, 100);
          }
        });
      });
    }

    // fallback multi-match finder
    function findAllMatches(screenImg, icon, tolerance = 100) {
      let results = [];
      let temp = screenImg;

      while (true) {
        let match = a1lib.findSubImage(temp, icon, tolerance);
        if (!match) break;

        results.push(match);

        const canvas = document.createElement("canvas");
        canvas.width = temp.width;
        canvas.height = temp.height;
        const ctx = canvas.getContext("2d");
        ctx.putImageData(temp, 0, 0);
        ctx.fillStyle = "black";
        ctx.fillRect(match.x, match.y, icon.width, icon.height);
        temp = ctx.getImageData(0, 0, temp.width, temp.height);
      }
      return results;
    }

    function startFinder() {
      if (!window.alt1) {
        setStatus("Not running in Alt1 ❌", "red");
        return;
      }
      if (!alt1.permissionPixel) {
        setStatus("Pixel permission not granted ❌", "red");
        return;
      }

      const screenW = alt1.rsWidth || 0;
      const screenH = alt1.rsHeight || 0;
      const screenImg = a1lib.getregion(0, 0, screenW, screenH);
      if (!screenImg) {
        setStatus("Failed to capture screen ❌", "red");
        return;
      }

      setStatus("Scanning for ability bars…");

      let allResults = [];

      Object.entries(icons).forEach(([name, icon]) => {
        if (!icon) return;

        let matches = null;
        try {
          if (typeof a1lib.findSubImage === "function") {
            matches = a1lib.findSubImage(screenImg, icon, 100, true);
          } else if (typeof a1lib.findsubimg === "function") {
            matches = a1lib.findsubimg(screenImg, icon, 100, true);
          }
        } catch (e) {
          console.warn(`Native multi-match failed for ${name}, fallback`, e);
        }

        if (!matches || (!Array.isArray(matches) && !matches.length)) {
          matches = findAllMatches(screenImg, icon, 100);
        }

        if (Array.isArray(matches) && matches.length > 0) {
          matches.forEach(m => {
            alt1.overLayRect(
              a1lib.mixcolor(0, 255, 0),
              m.x, m.y,
              icon.width, icon.height,
              3000, 3
            );
            allResults.push({
              image: name,
              x: m.x,
              y: m.y,
              w: icon.width,
              h: icon.height
            });
          });
        }
      });

      if (allResults.length > 0) {
        setStatus(`Found ${allResults.length} matches ✅`);
        setDebug(JSON.stringify(allResults, null, 2));
      } else {
        setStatus("No ability bars found ❌", "red");
      }
    }
  </script>
</body>
</html>
