<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RS3 Stats Detector</title>
  <link rel="stylesheet" type="text/css" href="https://runeapps.org/nis/nis.css">
  <script src="https://runeapps.org/alt1lib.js"></script>
  <style>
    #status {
      margin-top: 10px;
      font-weight: bold;
      color: lime;
    }
    button { margin-top: 10px; }
  </style>
</head>
<body class="nis">
  <div class="nismainborder nisborder" style="padding: 20px; position: relative;">
    <h2>RS3 Stats Detector</h2>
    <button onclick="startFinder()">Start Stats Finder</button>
    <div id="status">Status: Waiting...</div>
  </div>

  <script>
    let statsReader = new a1lib.ImageDetect("./statanchor.png");
    let findInterval = null;
    let statsPos = null;
    const TIMEOUT = 30000; // stop after 30s if not found

    function updateStatus(msg, color='lime') {
      console.log(msg);
      const statusDiv = document.getElementById("status");
      statusDiv.innerText = "Status: " + msg;
      statusDiv.style.color = color;
    }

    function showOverlay(rect, color=[255,0,0,128], duration=3000) {
      alt1.overLayRect(color, rect.x, rect.y, rect.width, rect.height, duration, 2);
    }

    // Check Alt1 presence
    function ensureAlt1Ready(callback) {
      if (!window.alt1) {
        updateStatus("Not running in Alt1 ❌", 'red');
        alert("This app must be run inside Alt1!");
        return false;
      }
      alt1.ready(() => {
        updateStatus("Alt1 detected ✅");
        callback();
      });
      return true;
    }

    async function startFinder() {
      try {
        await ensureAlt1Ready(); // waits until Alt1 is ready
      } catch(e) {
        return; // stop if not running in Alt1
      }
    
      if (!alt1.permissionPixel) {
        alert("Pixel permission not granted! Check Alt1 settings.");
        return;
      }
    
      updateStatus("Loading anchor image...");
      try {
        await statsReader.load();
        updateStatus("Anchor loaded ✅");
        statsReader.overLay(200, 200, 10000); // show anchor for debugging
      } catch(err) {
        console.error(err);
        updateStatus("Error loading anchor ❌", "red");
        return;
      }
    
      // Start searching
      let startTime = Date.now();
      updateStatus("Searching for stats window...");
    
      findInterval = setInterval(async () => {
        if (Date.now() - startTime > TIMEOUT) {
          clearInterval(findInterval);
          updateStatus("Stats not found within timeout ❌", "red");
          return;
        }
    
        try {
          const matches = await statsReader.find();
          console.log("Matches found:", matches);
    
          if (matches.length > 0) {
            statsPos = matches[0];
            clearInterval(findInterval);
    
            alt1.overLayRect([0,255,0,128], statsPos.x, statsPos.y, 150, 200, 5000, 2);
            alt1.overLayText("Stats Found!", [255,255,0,255], 20, statsPos.x, statsPos.y - 25, 5000);
    
            updateStatus(`Stats window found at X: ${statsPos.x} Y: ${statsPos.y} ✅`);
          } else {
            updateStatus("Searching for stats window...");
          }
        } catch(err) {
          console.error(err);
          updateStatus("Error during search ❌", "red");
        }
      }, 1000);
    }
  </script>
</body>
</html>
