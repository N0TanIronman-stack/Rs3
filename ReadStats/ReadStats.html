<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RS3 Stats Anchor Finder (multi)</title>
  <script src="https://runeapps.org/alt1lib.js"></script>
  <style>
    #status { margin-top: 10px; font-weight: bold; color: lime; }
    #debug { margin-top: 10px; font-size: 12px; white-space: pre-line; color: #ccc; }
  </style>
</head>
<body>
  <h2>Anchor Finder Multi-Test</h2>
  <button onclick="loadAssets()">Scan All Anchors</button>
  <div id="status">Waiting…</div>
  <div id="debug"></div>

  <script>
    let statAnchorData = null;

    function setStatus(msg, color = "lime") {
      const el = document.getElementById("status");
      el.innerText = msg;
      el.style.color = color;
      console.log("STATUS:", msg);
    }
    function setDebug(msg) {
      document.getElementById("debug").innerText = msg;
      console.log("DEBUG:", msg);
    }

    function loadImageData(path, callback) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = path;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        callback(ctx.getImageData(0, 0, img.width, img.height));
      };
      img.onerror = () => setStatus(`Failed to load ${path}`, "red");
    }

    function loadAssets() {
      loadImageData("./statanchor.png", data => {
        statAnchorData = data;
        setStatus("Anchor image loaded");
        setTimeout(startFinder, 100);
      });
    }

    // Fallback loop if native multi-match not available
    function findAllMatches(screenImg, icon, tolerance = 35) {
      let results = [];
      let temp = screenImg;

      while (true) {
        let match = a1lib.findSubImage(temp, icon, tolerance);
        if (!match) break;

        results.push(match);

        // mask the found region to avoid repeat match
        const canvas = document.createElement("canvas");
        canvas.width = temp.width;
        canvas.height = temp.height;
        const ctx = canvas.getContext("2d");
        ctx.putImageData(temp, 0, 0);
        ctx.fillStyle = "black";
        ctx.fillRect(match.x, match.y, icon.width, icon.height);
        temp = ctx.getImageData(0, 0, temp.width, temp.height);
      }
      return results;
    }

    function startFinder() {
      if (!window.alt1) {
        setStatus("Not running in Alt1 ❌", "red");
        return;
      }
      if (!alt1.permissionPixel) {
        setStatus("Pixel permission not granted ❌", "red");
        return;
      }
      if (!statAnchorData) {
        setStatus("Anchor image data not loaded ❌", "red");
        return;
      }

      const screenW = alt1.rsWidth || 0;
      const screenH = alt1.rsHeight || 0;
      const screenImg = a1lib.getregion(0, 0, screenW, screenH);
      if (!screenImg) {
        setStatus("Failed to capture screen ❌", "red");
        return;
      }

      setStatus("Scanning for all anchors…");

      let matches = null;

      try {
        // Check if API supports multi-match flag
        if (typeof a1lib.findSubImage === "function") {
          matches = a1lib.findSubImage(screenImg, statAnchorData, 35, true);
        } else if (typeof a1lib.findsubimg === "function") {
          matches = a1lib.findsubimg(screenImg, statAnchorData, 35, true);
        }
      } catch (e) {
        console.warn("Native multi-match failed, falling back", e);
      }

      // Fallback if we only got a single object or null
      if (!matches || (!Array.isArray(matches) && !matches.length)) {
        matches = findAllMatches(screenImg, statAnchorData, 35);
      }

      if (Array.isArray(matches) && matches.length > 0) {
        setStatus(`Found ${matches.length} anchors ✅`);
        matches.forEach(m => {
          alt1.overLayRect(
            a1lib.mixcolor(0, 255, 0),
            m.x, m.y,
            statAnchorData.width, statAnchorData.height,
            3000, 3
          );
        });
        setDebug(JSON.stringify(matches, null, 2));
      } else if (matches && matches.x !== undefined) {
        // single object
        setStatus("Found 1 anchor ✅");
        alt1.overLayRect(
          a1lib.mixcolor(0, 255, 0),
          matches.x, matches.y,
          statAnchorData.width, statAnchorData.height,
          3000, 3
        );
        setDebug(JSON.stringify(matches, null, 2));
      } else {
        setStatus("No anchors found ❌", "red");
      }
    }
  </script>
</body>
</html>
