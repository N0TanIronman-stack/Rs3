<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RS3 Stats Detector</title>
  <link rel="stylesheet" type="text/css" href="https://runeapps.org/nis/nis.css">
  <script src="https://runeapps.org/alt1lib.js"></script>
  <style>
    #status {
      margin-top: 10px;
      font-weight: bold;
      color: lime;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>
<body class="nis">
  <div class="nismainborder nisborder" style="padding: 20px; position: relative;">
    <h2>RS3 Stats Detector</h2>
    <button onclick="startFinder()">Start Stats Finder</button>
    <div id="status">Status: Waiting...</div>
  </div>

  <script>
    const statsReader = new a1lib.ImageDetect("./statanchor.png");
    let findInterval = null;
    let statsPos = null;
    const TIMEOUT = 30000; // 30-second search timeout

    function updateStatus(msg, color='lime') {
      console.log(msg);
      const statusDiv = document.getElementById("status");
      statusDiv.innerText = "Status: " + msg;
      statusDiv.style.color = color;
    }

    function showOverlay(rect, color=[255,0,0,128], duration=3000) {
      alt1.overLayRect(color, rect.x, rect.y, rect.width, rect.height, duration, 2);
    }

    function ensureAlt1Ready() {
      return new Promise((resolve, reject) => {
        if (!window.alt1) {
          updateStatus("Not running in Alt1 ❌", 'red');
          alert("This app must be run inside Alt1!");
          reject("Not in Alt1");
          return;
        }
        alt1.ready(() => {
          updateStatus("Alt1 detected ✅");
          resolve();
        });
      });
    }

    async function startFinder() {
      try {
        await ensureAlt1Ready();
      } catch(e) { return; }

      if (!alt1.permissionPixel) {
        alert("Pixel permission not granted! Check Alt1 settings.");
        return;
      }

      // Load anchor image
      updateStatus("Loading anchor image...");
      try {
        await statsReader.load();
        updateStatus("Anchor loaded ✅");
        statsReader.overLay(200, 200, 10000); // display anchor for reference
      } catch(err) {
        console.error("Anchor load error:", err);
        updateStatus("Error loading anchor ❌", 'red');
        return;
      }

      // Start search interval
      const startTime = Date.now();
      updateStatus("Searching for stats window...");

      findInterval = setInterval(async () => {
        if (Date.now() - startTime > TIMEOUT) {
          clearInterval(findInterval);
          updateStatus("Stats not found within timeout ❌", 'red');
          return;
        }

        try {
          const matches = await statsReader.find();
          console.log("Matches found:", matches);

          if (matches.length > 0) {
            statsPos = matches[0];
            clearInterval(findInterval);

            // Overlay rectangle & text for found stats
            showOverlay({x: statsPos.x, y: statsPos.y, width: 150, height: 200}, [0,255,0,128], 5000);
            alt1.overLayText("Stats Found!", [255,255,0,255], 20, statsPos.x, statsPos.y - 25, 5000);

            updateStatus(`Stats window found at X: ${statsPos.x} Y: ${statsPos.y} ✅`);
          } else {
            updateStatus("Searching for stats window...");
          }
        } catch(err) {
          console.error("Error during search:", err);
          updateStatus("Error during search ❌", 'red');
        }
      }, 1000);
    }
  </script>
</body>
</html>
