<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RS3 Stats Detector v1.8</title>
  <link rel="stylesheet" type="text/css" href="https://runeapps.org/nis/nis.css">
  <script src="https://runeapps.org/alt1lib.js"></script>
  <script src="https://www.unpkg.com/alt1/dist/ocr/index.js"></script>
  <style>
    #status { margin-top: 10px; font-weight: bold; color: lime; }
    #debug { margin-top: 10px; font-size: 12px; white-space: pre-line; color: #ccc; }
    #version { margin-top: 5px; font-size: 12px; color: gray; }
  </style>
</head>
<body class="nis">
  <div class="nismainborder nisborder" style="padding: 20px; position: relative;">
    <h2>RS3 Stats Detector</h2>
    <button onclick="loadAssets()">Start Stats Finder</button>
    <div id="status">Waiting…</div>
    <div id="debug"></div>
    <div id="version">Build v1.8 (adaptive & bottom edge)</div>
  </div>

  <script>
    let statAnchorData = null, statBorderData = null, statRoofData = null;

    function setStatus(msg, color = "lime") {
      const el = document.getElementById("status");
      el.innerText = msg;
      el.style.color = color;
      console.log(msg);
    }

    function setDebug(msg) {
      document.getElementById("debug").innerText = msg;
      console.log("DEBUG:", msg);
    }

    function loadImage(path, callback) {
      const img = new Image();
      img.src = path;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        callback(ctx.getImageData(0, 0, img.width, img.height));
      };
      img.onerror = () => setStatus(`Failed to load ${path} ❌`, "red");
    }

    function loadAssets() {
      loadImage("./statanchor.png", data => {
        statAnchorData = data;
        loadImage("./statborder.png", data2 => {
          statBorderData = data2;
          loadImage("./statroof.png", data3 => {
            statRoofData = data3;
            startFinder();
          });
        });
      });
    }

    function matchesIconAt(x0, y0, screenImg, icon, threshold = 0.9) {
      const iw = icon.width, ih = icon.height;
      const iconPixels = icon.data;
      const cw = screenImg.width, ch = screenImg.height;
      const pixels = screenImg.data;

      if (x0 < 0 || y0 < 0 || x0 + iw > cw || y0 + ih > ch) return false;

      let matchCount = 0, total = iw * ih;

      for (let iy = 0; iy < ih; iy++) {
        for (let ix = 0; ix < iw; ix++) {
          const ci = 4 * ((x0 + ix) + (y0 + iy) * cw);
          const ii = 4 * (ix + iy * iw);

          const r1 = pixels[ci], g1 = pixels[ci+1], b1 = pixels[ci+2];
          const r2 = iconPixels[ii], g2 = iconPixels[ii+1], b2 = iconPixels[ii+2];

          if (Math.abs(r1 - r2) < 35 && Math.abs(g1 - g2) < 35 && Math.abs(b1 - b2) < 35) {
            matchCount++;
          }
        }
      }

      return matchCount / total;
    }

    function findEdge(anchorX, anchorY, screenImg, direction) {
      const cw = screenImg.width, ch = screenImg.height;
      const maxRange = (direction === "left" || direction === "right") ? Math.floor(cw / 2) : Math.floor(ch / 2);
      const verticalSpan = 80;
      let best = {score: 0, x: 0, y: 0};

      for (let d = 1; d <= maxRange; d++) {
        for (let offsetY = -verticalSpan; offsetY <= verticalSpan; offsetY++) {
          let testX = anchorX;
          let testY = anchorY + offsetY;

          if (direction === "left") testX = anchorX - d;
          if (direction === "right") testX = anchorX + statAnchorData.width + d;
          if (direction === "up") testY = anchorY - d;
          if (direction === "down") testY = anchorY + statAnchorData.height + d;

          const tpl = (direction === "up") ? statRoofData : statBorderData;
          const score = matchesIconAt(testX, testY, screenImg, tpl);

          if (score > best.score) {
            best = {score, x: testX, y: testY};
          }
        }
      }

      return (best.score >= 0.85) ? best : null;
    }

    function findEdges(anchorX, anchorY, screenImg) {
      let leftX = anchorX;
      let rightX = anchorX + statAnchorData.width;
      let topY = anchorY;
      let bottomY = anchorY + statAnchorData.height;

      const left = findEdge(anchorX, anchorY, screenImg, "left");
      const right = findEdge(anchorX, anchorY, screenImg, "right");
      const top = findEdge(anchorX, anchorY, screenImg, "up");
      const bottom = findEdge(anchorX, anchorY, screenImg, "down");

      if (left) { leftX = left.x; alt1.overLayRect(a1lib.mixcolor(255,0,0), left.x, left.y, 5, 5, 4000, 2); }
      if (right) { rightX = right.x + statBorderData.width; alt1.overLayRect(a1lib.mixcolor(255,0,0), right.x, right.y, 5, 5, 4000, 2); }
      if (top) { topY = top.y; alt1.overLayRect(a1lib.mixcolor(255,0,0), top.x, top.y, 5, 5, 4000, 2); }
      if (bottom) { bottomY = bottom.y + statBorderData.height; alt1.overLayRect(a1lib.mixcolor(255,0,0), bottom.x, bottom.y, 5, 5, 4000, 2); }

      return {x: leftX, y: topY, w: rightX - leftX, h: bottomY - topY};
    }

    function startFinder() {
      if (!window.alt1) {
        setStatus("Not running in Alt1 ❌", "red");
        return;
      }
      if (!alt1.permissionPixel) {
        setStatus("Pixel permission not granted ❌", "red");
        return;
      }

      const screenW = alt1.rsWidth || 0;
      const screenH = alt1.rsHeight || 0;
      const screenImg = a1lib.getregion(0, 0, screenW, screenH);

      if (!screenImg) {
        setStatus("Failed to capture screen ❌", "red");
        return;
      }

      setStatus("Scanning for stat anchor…");

      const match = matchIcon(screenImg, statAnchorData);
      if (match) {
        const absX = match.x;
        const absY = match.y;
        alt1.overLayRect(a1lib.mixcolor(0, 255, 0), absX, absY, statAnchorData.width, statAnchorData.height, 3000, 3);
        setStatus(`Found stat anchor at X:${absX}, Y:${absY} ✅`);

        const region = findEdges(absX, absY, screenImg);
        alt1.overLayRect(a1lib.mixcolor(0, 0, 255), region.x, region.y, region.w, region.h, 5000, 3);
        setDebug(`Region → X:${region.x}, Y:${region.y}, W:${region.w}, H:${region.h}`);
        setStatus(`Stat window detected ✅`);
      } else {
        setStatus("Could not find stat anchor ❌", "red");
      }
    }

    function matchIcon(screenImg, icon) {
      const cw = screenImg.width, ch = screenImg.height;
      for (let y = 0; y <= ch - icon.height; y++) {
        for (let x = 0; x <= cw - icon.width; x++) {
          if (matchesIconAt(x, y, screenImg, icon) > 0.9) {
            return {x: x, y: y};
          }
        }
      }
      return null;
    }
  </script>
</body>
</html>
